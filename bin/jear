#!/usr/bin/env node

process.env.DEBUG = 'jear'
var debug = require('debug')('jear')

debug('start')

var fs = require('fs')
var path = require('path')
var config = JSON.parse(fs.readFileSync(__dirname + '/../package.json'))
require('shelljs/global')

var program = require("commander")
var version = config.version

program.
  version(version).
  usage('[option] <file.vm>').
  option('-o, --output', 'out put filename').
  option('-p, --parseJSON', 'parse html, get json data')

program.on('--help', function(){
  console.log('  Examples:')
  console.log('')
  console.log('    $ jear xx.vm')
  console.log('')
  console.log('  jear@%s %s', version, __filename)
  console.log('')
})

program.parse(process.argv)

if (!program.args.length) {

  program.help()

} else {

  var cwd = process.cwd()
  var jsonify = require('../lib/index')

  if (program.parseJSON) {
    var parse = require('../lib/parse').parse
    var file = path.join(cwd, program.args[0])
    parse(file)
    return
  }

  program.args.forEach(function(f){

    var file = path.join(cwd, f)
    var basename = path.basename(f)

    if (!fs.existsSync(file)) return;

    var str = fs.readFileSync(file).toString()

    var mockDir = path.dirname(file) + '/mock/'
    if (!test('-d', mockDir)) {
      mkdir(mockDir)
      debug('create mock dir')
    }

    var json = new jsonify(str).toJson()

    debug('get json from file ' + basename)
    json.to(mockDir + basename)
    debug('success save mock file to mock/' + basename)

  })

}

/**
 * vim: ft=javascript:tw=80:
 */
